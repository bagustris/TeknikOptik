function CO2A(action)% OP2DRIVERA This GUI object is designed to be used %        in the Computational Optoelectronics course.%        It stores all the variables which are%        used globally in the second exercise (CO2A).%%        There is one action button:%        RECALCULATE: the values are accepted and the%             intensity distribution on the screen calculated.%             This calculation is done by one of two externally%             written scripts HUYGENS2.m or GC.m.%%        On entry, the optional variable ACTION determines%        possible actions to be taken.%--------------------------------------------------------------------%         Test the entry information is in order%--------------------------------------------------------------------	   set(0,'ShowHiddenHandles','on');% Set up default ACTION if it wasn't explicitly passed.if nargin==0,   action = 'OpenReopen'; end;   % ------------------------------------------------------------------% ------------------------------------------------------------------% PART 1:    INITIALIZE THE GRAPHICAL USER INTERFACE% ------------------------------------------------------------------% ------------------------------------------------------------------% This is where the input variables are specified.% You specify the number of variables, their names, their units% and their default values.   numInVars = 6;   inputVars = ...	  {'lambda';'scrnWdth';'scrnDist';'slitWdth';'slitSepn';'numSlits'};   inputUnits = ...	  {  'm'   ;   'm'    ;   'm'    ;   'm'    ;   'm'    ; ''};   inputValus = ...	  {'600e-9'; '24e-3'  ;  '50e-3' ; '5.0e-6' ; '10.0e-6'; '2'};  % The input variables are made global in the local workspace % and also in the command workspace.   globalStatement = ['global'];   for i=1:numInVars,      globalStatement = [globalStatement, ' ', char(inputVars(i))];   end;   globalStatement = [globalStatement,';'];   eval(globalStatement);   evalin('base', globalStatement);	   	    % Some extra constants needed,   tealColor  = [0.7,0.7,0.50];   lightColor = [0.0,0.73,0.60];   grayColor  = [0.4,0.4,0.4];   panelName  = 'CO2A Input panel';   panelTag   = 'CO2AInputPanel'; % Set up default graphing colours   set(0,'defaultfigurecolor','black');   % Black backgrounds for all graphs   set(0,'defaultaxescolor'  ,'black');   set(0,'defaultaxesXColor' ,'white');   % White printing for all axes   set(0,'defaultaxesYColor' ,'white');if strcmp(action,'OpenReopen')    % ---------------------------------------------------   %        Reopen the figure or make a new one   % ---------------------------------------------------   h_figs   = get(0,'children');   Hf_input = findobj(h_figs,'flat','tag', panelTag);   % Note: the figure used is tagged with the string panelTag.   % If it's not open, the figure will have to be initialized,   % and all the global variables set to their default values.    if length(Hf_input)==0, % If the panel is not not already open perform the following:          % ---------------------------------------------------      %      Give the variables their default values      % ---------------------------------------------------      for i=1:numInVars,         itemStr = char(inputVars(i));      % variable names	     valuStr = char(inputValus(i));     % default values         eval([itemStr '=' valuStr ';']);      end;       					    						      % ---------------------------------------------------    %         Calculate all display dimensions    % ---------------------------------------------------	% First establish the height and width of the screen	  defaultUnits = get(0,'units');	  set(0,'units','centimeters');     % Our positions are in cm	  scrnSize   = get(0,'screensize'); 	  set(0,'units', defaultUnits);     % Restore root figure	  scrnWidth   = scrnSize(1,3);	  scrnHeight  = scrnSize(1,4);	     % Set dimensions of the input panel	  panelWidth  = 10.0;	  varblHeight = 1.3;	  panelHeight = 4.0 + numInVars*varblHeight;	  panelRect   = [panelWidth panelHeight];					  panelTop    = [scrnWidth scrnHeight]*0.9;	  panelCorner = panelTop - panelRect;	      % Set dimensions of the frame in the panel	  frameMargin = 0.6;	  frameHeight = (numInVars+0.5) * varblHeight;	  frameWidth  = panelWidth - 2*frameMargin;	  frameLeft   = (panelWidth-frameWidth)/2;	  frameRect   = [frameWidth frameHeight];	  frameTop    = panelHeight - frameMargin;	  frameCorner = [frameLeft frameTop-frameHeight];	      % Set dimensions of the 'recalculate' button	  buttnWidth  = 5.0;	  buttnHeight = frameCorner(1,2) - 2*frameMargin;	  buttnLeft   = (panelWidth-buttnWidth)/2;	  buttnRect   = [buttnWidth buttnHeight];	  buttnCorner = [buttnLeft frameMargin];    % Set dimensions of the frame title	  textHeight  = 0.5;	  textOffset  = 0.8;	  titleWidth  = 3.5;	  titleLeft   = frameLeft + textOffset/2;	  titleBottom = frameTop - textHeight/2;	  titleRect   = [titleWidth textHeight];	      % Set dimensions of the text boxes	  namesWidth   = 2.2;	  namesLeft    = frameLeft + textOffset;	  namesTop     = frameTop;	  namesRect    = [namesWidth textHeight];	  	  unitWidth    = 1.0;	  unitLeft     = frameLeft + frameWidth - textOffset - unitWidth;	  unitRect     = [unitWidth textHeight];	  valueWidth   = frameWidth - namesWidth-unitWidth-2*textOffset;	  valueLeft    = (namesLeft+namesWidth + unitLeft-valueWidth)/2;	  valueRect    = [valueWidth 1.4*textHeight];							  							      % ---------------------------------------------------    %         Open panel and record handle    % ---------------------------------------------------      Hf_input = figure('color',tealColor,...                          'units','centimeters', ...                          'position',[panelCorner panelRect],...                          'Name',panelName,...						  'HandleVisibility','off',...				          'Tag',panelTag,...				          'NumberTitle','off');      handles(1) = Hf_input;  	  	  			        % ---------------------------------------------------      %    Set up objects to determine/display variables      % ---------------------------------------------------      % ------------------------------------      %         Input variables      % ------------------------------------      % The frame for input variables	  handInpt1 = 2;      handles(handInpt1) = uicontrol(Hf_input,...	                        'style','frame',...                            'backgroundcolor',tealColor,...                            'units','centimeters',...                            'position',[frameCorner frameRect]);							% Note: this handle not kept!      % name for the frame       handles(handInpt1) = uicontrol(Hf_input,...	                        'style','text',...                            'units','centimeters',...                            'backgroundcolor',tealColor,...    	                    'position',[titleLeft titleBottom titleWidth textHeight],...                            'string','Input variables');							% Note: this handle not kept!	  for i=1:numInVars,	     handInpt = handInpt1+i-1;           % number of current handle	     bottom   = namesTop-varblHeight*i;		 grphVar  = char(inputVars(i));		 valuVar  = inputValus(i);		 unit     = char(inputUnits(i));      % name for the variable          handles(handInpt) = uicontrol(Hf_input,...	                        'style','text',...                            'units','centimeters',...                            'backgroundcolor',tealColor,...    	                    'position',[namesLeft bottom namesRect],...                            'string',[grphVar ' =']);							% Note: this handle not kept!       % units for the variable          handles(handInpt) = uicontrol(Hf_input,...	                        'style','text',...                            'units','centimeters',...                            'backgroundcolor',tealColor,...     	                    'position',[unitLeft bottom unitRect],...                            'string',unit);  							% Note: this handle not kept!       % input for the variable         handles(handInpt) = uicontrol(Hf_input,...	                        'Style','edit',...							'Visible','on',...                            'units','centimeters',...                            'position',[valueLeft bottom-0.1 valueRect],...                            'String',valuVar);	  end; 							       % ---------------------------------------------------      %         Set up action buttons      % ---------------------------------------------------						      handActn = handInpt+1;	  % (19) Button for recalculate      handles(handActn) = uicontrol(Hf_input,...	                        'Style','pushbutton',...                            'backgroundcolor',tealColor,...                            'units','centimeters',...                            'position',[buttnCorner buttnRect],...                            'string','Recalculate');	         recalcCall = ...         ['CO2A(''Recalculate'')'];      set(handles(handActn),'callback',recalcCall);	   	         set(Hf_input,'userdata',handles); 	   	  % ------------------------------------------------------ %     If figure pre-existing, retrieve parameters % ------------------------------------------------------      else      handles = get(Hf_input,'userdata');	  figure(Hf_input);	  % bring the panel forward	     end;    % if length(Hf_input)==0   end;     % if strcmp(action,'OpenReopen')% ------------------------------------------------------------------% ------------------------------------------------------------------% ------------------------------------------------------------------% PART 2:  ACCEPT THE VARIABLES AND RECALCULATE% ------------------------------------------------------------------if strcmp(action,'Recalculate')      % ---------------------------------------------------   %        Recall all the experimental variables   % ---------------------------------------------------   Hf_input   = gcf;   handles    = get(Hf_input,'userdata');   for i=1:numInVars,      itemStr = char(inputVars(i));          % variable names	  valuStr = get(handles(i+1),'String');  % variable values      eval([itemStr '=' char(valuStr) ';']);   end;         % ---------------------------------------------------   %        Reopen the graph or make a new one   % ---------------------------------------------------   h_figs    = get(0,'children');   Hf_screen = findobj(h_figs,'flat','tag','ScreenGraph');   % Note: the figure used is tagged with the name 'ScreenGraph'.   % If it's not open, the figure will have to be initialized,   % and the appropriate axes set up.    if length(Hf_screen)==0,%  If the graph is not not already open perform the following: 	  screenWidth  = 0.90;	  screenHeight = 0.40;	  screenRect   = [screenWidth screenHeight];					  screenCorner = [0.02 0.06];	        % ---------------------------------------------------      %         Open screen and record handle      % ---------------------------------------------------      Hf_screen = figure('color','black',...                         'units','normalized', ...                         'position',[screenCorner screenRect],...                         'Name','Intensity on the screen',...			             'Tag','ScreenGraph',...			             'renderer','zbuffer',...			             'NumberTitle','off');    % ---------------------------------------------------    %      Set properties of the intensity graph    % ---------------------------------------------------    % Specify the intensity axes inside the window      Ha_itot = axes('Color','black',...                     'Position',[0.080 0.400 , 0.850 0.500],...					 'xlim',[-scrnWdth/2,+scrnWdth/2],...                     'Box','on');					     % Specify the properties of the intensity graph 	  H_xlabel = get(Ha_itot,'xlabel');	  set(H_xlabel,'String','Position  along  the  screen   (m)')	  	  	  H_ylabel = get(Ha_itot,'ylabel');	  set(H_ylabel,'String','Intensity   (arbitrary  units)')	  	        Hl_itot = line('color','yellow',...					 'xdata',0,'ydata',0);					     % ---------------------------------------------------    %  Set properties of the simulated screen pattern    % ---------------------------------------------------    % Specify the grayscale graph inside the window      Ha_gray = axes('Color','black',...                     'Position',[0.080 0.100 , 0.850 0.150],...					 'xlim',[-scrnWdth/2,+scrnWdth/2],...                     'Box','on');					      % Record the handles for future plotting	  set(Hf_screen,'userdata',[Ha_itot, Hl_itot, Ha_gray]);	     else 	  figure(Hf_screen);	% bring screen graph forward by getting handles for graphs	  handles = get(Hf_screen,'userdata');	  Ha_itot = handles(1,1);	  Hl_itot = handles(1,2);	  Ha_gray = handles(1,3);	  	  			     end; % if length(Hf_screen)==0,      % ------------------------------------------------------% ------------------------------------------------------% PART 3: CALCULATE AND PLOT THE INTENSITY DISTRIBUTIONS% ------------------------------------------------------% ------------------------------------------------------ % ------------------------------------------ % (1) CALCULATE THE INTERFERENCE PATTERNS % ------------------------------------------     % Call external function to calculate intensity distribution % This function must be given the name "Huygens" % It specifies the array of detector positions yd     [yd , Itot] = Huygens2;         % ------------------------------------------ % (2)   PLOT INTENSITY AS A LINE GRAPH % ------------------------------------------ % open the graphs panel and aelect color for graphs % to match the wavelength   figure(Hf_screen);      graphColor = ColorCode(lambda);    % Plot the intensity vs yd graph   set(Ha_itot,'XLim',[-scrnWdth/2,+scrnWdth/2]);   set(Hl_itot,'color',graphColor,...               'xdata',yd,...               'ydata',Itot);   zoom on; % ------------------------------------------ % (2) DRAW THE SIMULATED SCREEN PATTERN % ------------------------------------------   set(Hf_screen,'CurrentAxes',Ha_gray)      % First construct gray scale in the graph colour.   grayMap = gray(64);   colormap(grayMap(:,1)*graphColor);      % Now do the actual plotting (as a contour)   [xSc, ySc] = meshgrid(yd,[-1, +1]);   zSc = [Itot';Itot'];   pcolor(xSc,ySc,zSc);   shading interp;   % Draw box around the grayscale representation   set(gca,'TickDir','out','YTick',[],...           'XLim',[-scrnWdth/2,+scrnWdth/2]);   line('color','white',...        'ydata',[-1,+1, +1, -1],...		'xdata',[-scrnWdth/2,-scrnWdth/2,scrnWdth/2,scrnWdth/2]);           % -----------------------------------------------------   %   Reset configuration for further calculations   % -----------------------------------------------------   % reopen the input panel   figure(Hf_input);      end;   % if strcmp(action,'Recalculate')% ------------------------------------------------------------------%          ALL INPUT ACTIONS COMPLETE  % ------------------------------------------------------------------   set(0,'ShowHiddenHandles','off');   return;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% % ------------------------------------------------------% ------------------------------------------------------% PART 4: SUBSIDIARY FUNCTIONS% ------------------------------------------------------% ------------------------------------------------------function thiscolor = ColorCode(lambda)% Return the color appropriate to the supplied wavelength.% Is it assumed the supplied lambda is within the range 380-780 nm% Smaller or higher values are set notionally to the extreme values % All input measurements are in metres. thiscolor = [0,0,0];lambda    = lambda*1e+9;    % Convert to nm.if lambda<380,    thiscolor = [1,0,1]; end;if (lambda>=380)&(lambda<440),   thiscolor = [(440-lambda)/(440-380),0,1]; end;if (lambda>=440)&(lambda<490),   thiscolor = [0,(lambda-440)/(490-440),1]; end;if (lambda>=490)&(lambda<510),   thiscolor = [0,1,(510-lambda)/(510-490)]; end;if (lambda>=510)&(lambda<580),   thiscolor = [(lambda-510)/(580-510),1,0]; end;if (lambda>=580)&(lambda<645),   thiscolor = [1,(645-lambda)/(645-580),0]; end;if (lambda>=645),   thiscolor = [1,0,0]; end;%  The intensities fall off near limits of visionif lambda>700,   thiscolor = thiscolor * (0.3 + 0.7*(780-lambda)/(780-700)); end;if lambda<420,   thiscolor = thiscolor * (0.3 + 0.7*(lambda-380)/(420-380)); end;return;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 